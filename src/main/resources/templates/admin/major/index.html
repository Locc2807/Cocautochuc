<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="https://www.thymeleaf.org/extras/spring-security6">
<head th:replace="admin/fragment/head :: head"></head>

<body>
	<div class="wrapper">

		<!-- Sidebar -->
		<div th:replace="admin/fragment/aside :: aside"></div>

		<div class="main-panel">
			<!-- Header -->
			<div th:replace="admin/fragment/header :: header"></div>

			<div class="container">
				<div class="page-inner">
					<div class="page-header">
						<h4 class="page-title">Danh sách Ngành</h4>
					</div>

					<!-- Form tìm kiếm và lọc -->
					<form class="row mb-3" th:action="@{/admin/major}" method="get">
						<div class="col-md-4">
							<input type="text" class="form-control" name="keyword"
								placeholder="Tìm kiếm (tên ngành)" th:value="${keyword}">
						</div>
						<div class="col-md-3">
							<select class="form-select" name="facultyId">
								<option value="" selected>-- Chọn Khoa --</option>
								<option th:each="f : ${faculties}" th:value="${f.facultyId}"
									th:text="${f.facultyName}"
									th:selected="${f.facultyId == facultyId}"></option>
							</select>
						</div>
						<div class="col-md-2">
							<button type="submit" class="btn btn-primary">Tìm / Lọc</button>
						</div>
					</form>

					<!-- Nút chỉnh sửa / thêm mới / hủy -->
					<div
						class="mb-3 d-flex justify-content-end align-items-center gap-2">
						<button type="button" id="btnAddNew" class="btn btn-success">
							<i class="fa fa-plus"></i> Thêm mới
						</button>
						<button type="button" id="btnEditToggle" class="btn btn-warning">
							<i class="fa fa-pen"></i> Chỉnh sửa
						</button>
						<button type="button" id="btnCancelEdit"
							class="btn btn-secondary d-none">
							<i class="fa fa-times"></i> Hủy chỉnh sửa
						</button>
					</div>

					<!-- Grid Card Layout -->
					<div class="row" th:if="${majorPage.content.size() > 0}">
						<div class="row-md-4 mb-3" th:each="major : ${majorPage.content}">
							<div class="card shadow-sm">
								<div class="card-body">
									<h5 class="card-title" th:text="${major.majorName}">Tên
										ngành</h5>
									<p class="card-text">
										<strong>Mã ngành:</strong> <span th:text="${major.majorCode}">---</span>
									</p>
									<p class="card-text">
										<strong>Khoa:</strong> <span
											th:text="${major.faculty != null ? major.faculty.facultyName : 'N/A'}">---</span>
									</p>
									<p class="card-text">
										<strong>Ngày thành lập:</strong> <span
											th:text="${#dates.format(major.establishedDate,'dd/MM/yyyy')}">---</span>
									</p>
									<p class="card-text">
										<strong>Mô tả:</strong> <span th:text="${major.description}">---</span>
									</p>
									<p class="card-text">
										<strong>Tổng số tín chỉ tối thiểu:</strong> <span
											th:text="${major.minCredits}">---</span>
									</p>
									<div
										class="edit-column d-none d-flex justify-content-end gap-2">
										<button class="btn btn-sm btn-primary btn-edit" title="Sửa"
											th:data-id="${major.majorId}">
											<i class="fa fa-edit"></i>
										</button>
										<button class="btn btn-sm btn-danger btn-delete" title="Xóa"
											th:data-id="${major.majorId}">
											<i class="fa fa-trash"></i>
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div th:if="${majorPage.content.size() == 0}">
						<p class="text-center">Không có ngành nào để hiển thị.</p>
					</div>

					<!-- Phân trang -->
					<div class="d-flex justify-content-center mt-3">
						<ul class="pagination">
							<li class="page-item"
								th:classappend="${!majorPage.hasPrevious()} ? 'disabled'">
								<a class="page-link"
								th:href="@{/admin/major(page=${majorPage.number - 1}, size=${majorPage.size})}">«</a>
							</li>
							<li class="page-item"
								th:each="i : ${#numbers.sequence(0, majorPage.totalPages - 1)}"
								th:classappend="${i == majorPage.number} ? 'active'"><a
								class="page-link"
								th:href="@{/admin/major(page=${i}, size=${majorPage.size})}"
								th:text="${i + 1}"></a></li>
							<li class="page-item"
								th:classappend="${!majorPage.hasNext()} ? 'disabled'"><a
								class="page-link"
								th:href="@{/admin/major(page=${majorPage.number + 1}, size=${majorPage.size})}">»</a>
							</li>
						</ul>
					</div>

				</div>
			</div>

			<!-- Footer -->
			<div th:replace="admin/fragment/footer :: footer"></div>
		</div>
	</div>

	<script th:src="@{/assets/js/core/jquery-3.7.1.min.js}"></script>
	<script th:src="@{/assets/js/core/popper.min.js}"></script>
	<script th:src="@{/assets/js/core/bootstrap.min.js}"></script>
	<script
		th:src="@{/assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js}"></script>
	<script th:src="@{/assets/js/plugin/chart.js/chart.min.js}"></script>
	<script
		th:src="@{/assets/js/plugin/jquery.sparkline/jquery.sparkline.min.js}"></script>
	<script th:src="@{/assets/js/plugin/chart-circle/circles.min.js}"></script>
	<script th:src="@{/assets/js/plugin/datatables/datatables.min.js}"></script>
	<script
		th:src="@{/assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js}"></script>
	<script th:src="@{/assets/js/plugin/jsvectormap/jsvectormap.min.js}"></script>
	<script th:src="@{/assets/js/plugin/jsvectormap/world.js}"></script>
	<script th:src="@{/assets/js/plugin/gmaps/gmaps.js}"></script>
	<script th:src="@{/assets/js/plugin/sweetalert/sweetalert.min.js}"></script>
	<script th:src="@{/assets/js/kaiadmin.min.js}"></script>


	<!-- JS Toggle Edit / Modal Add & Edit / Delete -->
	<script>
	const btnEditToggle = document.getElementById('btnEditToggle');
	const btnCancel = document.getElementById('btnCancelEdit');
	const btnAddNew = document.getElementById('btnAddNew');
	const editColumns = document.querySelectorAll('.edit-column');

	// Toggle edit mode
	btnEditToggle.addEventListener('click', () => {
		editColumns.forEach(col => col.classList.remove('d-none'));
		btnAddNew.classList.remove('d-none');
		btnEditToggle.classList.add('d-none');
		btnCancel.classList.remove('d-none');
	});

	btnCancel.addEventListener('click', () => {
		editColumns.forEach(col => col.classList.add('d-none'));
		btnAddNew.classList.add('d-none');
		btnEditToggle.classList.remove('d-none');
		btnCancel.classList.add('d-none');
	});

	// Modal Thêm Ngành
	btnAddNew.addEventListener('click', () => {
		const modal = new bootstrap.Modal(document.getElementById('addMajorModal'));
		document.getElementById('modalTitle').innerText = "Thêm Ngành Mới";
		document.getElementById('majorName').value = '';
		document.getElementById('majorCode').value = '';
		document.getElementById('majorFacultyId').value = '';
		document.getElementById('majorDate').value = '';
		document.getElementById('majorDescription').value = '';
		document.getElementById('majorMinCredits').value = '';
		document.getElementById('btnSaveModal').setAttribute('onclick', 'saveNewMajor()');
		modal.show();
	});

	// Sửa
	document.addEventListener('click', async function(e){
		const btn = e.target.closest('.btn-edit');
		if(!btn) return;
		const id = btn.getAttribute('data-id');
		const res = await fetch(`/api/majors/${id}`);
		if(!res.ok) return alert('Không lấy được dữ liệu!');
		const data = await res.json();
		document.getElementById('majorName').value = data.majorName;
		document.getElementById('majorCode').value = data.majorCode;
		document.getElementById('majorFacultyId').value = data.faculty?.facultyId || '';
		document.getElementById('majorDate').value = data.establishedDate || '';
		document.getElementById('majorDescription').value = data.description;
		document.getElementById('majorMinCredits').value = data.minCredits;
		document.getElementById('modalTitle').innerText = "Chỉnh sửa Ngành";
		document.getElementById('btnSaveModal').setAttribute('onclick', `updateMajor(${id})`);
		new bootstrap.Modal(document.getElementById('addMajorModal')).show();
	});

	// Xóa
	document.addEventListener('click', function(e){
		const btn = e.target.closest('.btn-delete');
		if(!btn) return;
		const id = btn.getAttribute('data-id');
		if(!confirm("Bạn có chắc chắn muốn xóa ngành này?")) return;
		const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
		const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
		fetch(`/api/majors/${id}`, {
			method: 'DELETE',
			headers: { [csrfHeader]: csrfToken }
		}).then(res => {
			if(res.ok) location.reload();
			else res.text().then(txt=>alert("Xóa thất bại: "+txt));
		}).catch(err=>console.error(err));
	});
	</script>

	<!-- Modal Add/Edit Major -->
	<div class="modal fade" id="addMajorModal" tabindex="-1"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="modalTitle">Thêm Ngành Mới</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<form>
						<div class="mb-3">
							<label class="form-label">Tên ngành</label> <input type="text"
								id="majorName" class="form-control">
						</div>
						<div class="mb-3">
							<label class="form-label">Mã ngành</label> <input type="text"
								id="majorCode" class="form-control">
						</div>
						<div class="mb-3">
							<label class="form-label">Thuộc khoa</label> <select
								id="majorFacultyId" class="form-select">
								<option value="" disabled selected>-- Chọn Khoa --</option>
								<option th:each="f : ${faculties}" th:value="${f.facultyId}"
									th:text="${f.facultyName}"></option>
							</select>
						</div>
						<div class="mb-3">
							<label class="form-label">Ngày thành lập</label> <input
								type="date" id="majorDate" class="form-control">
						</div>
						<div class="mb-3">
							<label class="form-label">Mô tả</label>
							<textarea id="majorDescription" class="form-control"></textarea>
						</div>
						<div class="mb-3">
							<label class="form-label">Tổng số tín chỉ tối thiểu</label> <input
								type="number" id="majorMinCredits" class="form-control" min="0">
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">Đóng</button>
					<button type="button" id="btnSaveModal" class="btn btn-success">Lưu</button>
				</div>
			</div>
		</div>
	</div>

</body>
</html>
