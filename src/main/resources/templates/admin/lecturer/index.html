<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="https://www.thymeleaf.org/extras/spring-security6">
<head th:replace="admin/fragment/head :: head"></head>

<body>
	<div class="wrapper">

		<!-- Sidebar -->
		<div th:replace="admin/fragment/aside :: aside"></div>

		<div class="main-panel">
			<!-- Header -->
			<div th:replace="admin/fragment/header :: header"></div>

			<div class="container">
				<div class="page-inner">
					<div class="page-header">
						<h4 class="page-title">Danh sách Giảng viên</h4>
					</div>

					<!-- Form tìm kiếm và lọc -->
					<form class="row mb-3" th:action="@{/admin/lecturer}" method="get">
						<div class="col-md-4">
							<input type="text" class="form-control" name="keyword"
								placeholder="Tìm kiếm theo chức vụ" th:value="${keyword}">
						</div>
						<div class="col-md-3">
							<select class="form-select" name="position">
								<option value="">-- Chọn chức vụ --</option>
								<option th:each="pos : ${positions}" th:value="${pos}"
									th:text="${pos}" th:selected="${pos == keyword}"></option>
							</select>
						</div>
						<div class="col-md-2">
							<button type="submit" class="btn btn-primary">Tìm</button>
						</div>
					</form>

					<!-- Nút thêm mới / chỉnh sửa -->
					<div
						class="mb-3 d-flex justify-content-end align-items-center gap-2">
						<button type="button" id="btnAddNew"
							class="btn btn-success d-none">
							<i class="fa fa-plus"></i> Thêm mới
						</button>
						<button type="button" id="btnEditToggle" class="btn btn-warning">
							<i class="fa fa-pen"></i> Chỉnh sửa
						</button>
						<button type="button" id="btnSaveChanges"
							class="btn btn-success d-none">
							<i class="fa fa-save"></i> Lưu thay đổi
						</button>
						<button type="button" id="btnCancelEdit"
							class="btn btn-secondary d-none">
							<i class="fa fa-times"></i> Hủy chỉnh sửa
						</button>
					</div>

					<!-- Danh sách giảng viên dạng card -->
					<div class="row" th:each="lecturer : ${lecturerPage}">
						<div class="row-md-4 mb-3">
							<div class="card">
								<div class="card-body">
									<h5 class="card-title" th:text="${lecturer.lecturerName}"></h5>
									<p class="card-text">
										<strong>Mã giảng viên:</strong><span
											th:text="${lecturer.lecturerCode}"></span><br> <strong>Trường:</strong>
										<span th:text="${lecturer.school?.name ?: 'N/A'}"></span><br>
										<strong>Chức vụ:</strong> <span th:text="${lecturer.position}"></span><br>
										<strong>Ngày bắt đầu:</strong> <span
											th:text="${#dates.format(lecturer.startDate, 'dd/MM/yyyy')}"></span><br>
										<strong>Loại hợp đồng:</strong> <span
											th:text="${lecturer.contractType != null ? lecturer.contractType : 'N/A'}"></span>
										<br> <strong>Email:</strong> <span
											th:text="${lecturer.email}"></span><br> <strong>Điện
											thoại:</strong> <span th:text="${lecturer.phone}"></span>
									</p>
								</div>
								<div class="card-footer edit-column d-none">
									<button class="btn btn-sm btn-primary me-1 btn-edit"
										th:data-id="${lecturer.lecturerId}" title="Sửa">
										<i class="fa fa-edit"></i>
									</button>
									<button class="btn btn-sm btn-danger btn-delete"
										th:data-id="${lecturer.lecturerId}" title="Xóa">
										<i class="fa fa-trash"></i>
									</button>
								</div>
							</div>
						</div>
					</div>

					<!-- Pagination -->
					<div class="d-flex justify-content-center mt-3">
						<ul class="pagination">
							<li class="page-item"
								th:classappend="${!lecturerPage.hasPrevious()} ? 'disabled'">
								<a class="page-link"
								th:href="@{/admin/lecturer(page=${lecturerPage.number - 1}, size=${lecturerPage.size})}">«</a>
							</li>
							<li class="page-item"
								th:each="i : ${#numbers.sequence(0, lecturerPage.totalPages - 1)}"
								th:classappend="${i == lecturerPage.number} ? 'active'"><a
								class="page-link"
								th:href="@{/admin/lecturer(page=${i}, size=${lecturerPage.size})}"
								th:text="${i + 1}"></a></li>
							<li class="page-item"
								th:classappend="${!lecturerPage.hasNext()} ? 'disabled'"><a
								class="page-link"
								th:href="@{/admin/lecturer(page=${lecturerPage.number + 1}, size=${lecturerPage.size})}">»</a>
							</li>
						</ul>
					</div>

				</div>
			</div>

			<!-- Footer -->
			<div th:replace="admin/fragment/footer :: footer"></div>
		</div>
	</div>

	<!-- Modal thêm/sửa giảng viên -->
	<div class="modal fade" id="lecturerModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="lecturerModalTitle">Thêm Giảng
						viên</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<form>
						<div class="mb-3">
							<label>Tên</label> <input id="lecturerName" class="form-control">
						</div>
						<div class="mb-3">
							<label>Mã giảng viên</label> <input id="lecturerCode"
								class="form-control">
						</div>
						<div class="mb-3">
							<label>Thuộc trường</label> <select id="lecturerSchoolId"
								class="form-select">
								<option disabled selected>-- Chọn trường --</option>
								<option th:each="s : ${schools}" th:value="${s.id}"
									th:text="${s.name}"></option>
							</select>
						</div>
						<div class="mb-3">
							<label>Chức vụ</label> <input id="lecturerPosition"
								class="form-control">
						</div>
						<div class="mb-3">
							<label>Ngày bắt đầu làm việc</label> <input
								id="lecturerStartDate" type="date" class="form-control">
						</div>
						<div class="mb-3">
							<label>Loại hợp đồng</label> <select id="lecturerContractType"
								class="form-select">
								<option value="">-- Chọn loại --</option>
								<option>Không xác định thời hạn</option>
								<option>Xác định thời hạn 12 tháng</option>
								<option>Xác định thời hạn 24 tháng</option>
							</select>
						</div>
						<div class="mb-3">
							<label>Email</label> <input id="lecturerEmail"
								class="form-control">
						</div>
						<div class="mb-3">
							<label>Số điện thoại</label> <input id="lecturerPhone"
								class="form-control">
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
					<button id="btnSaveLecturerModal" class="btn btn-success"
						onclick="saveNewLecturer()">Lưu</button>
				</div>
			</div>
		</div>
	</div>

	<script>
/* ============== Toggle chế độ chỉnh sửa ============== */
const btnLecturerEditToggle = document.getElementById('btnEditToggle');
const btnLecturerSave = document.getElementById('btnSaveChanges');
const btnLecturerCancel = document.getElementById('btnCancelEdit');
const btnLecturerAddNew = document.getElementById('btnAddNew');
const lecturerEditColumns = document.querySelectorAll('.edit-column');

btnLecturerEditToggle.addEventListener('click', () => {
    lecturerEditColumns.forEach(col => col.classList.remove('d-none'));
    btnLecturerAddNew.classList.remove('d-none');
    btnLecturerEditToggle.classList.add('d-none');
    btnLecturerSave.classList.remove('d-none');
    btnLecturerCancel.classList.remove('d-none');
});

btnLecturerCancel.addEventListener('click', () => {
    lecturerEditColumns.forEach(col => col.classList.add('d-none'));
    btnLecturerAddNew.classList.add('d-none');
    btnLecturerEditToggle.classList.remove('d-none');
    btnLecturerSave.classList.add('d-none');
    btnLecturerCancel.classList.add('d-none');
});

/* ============== Mở modal thêm giảng viên ============== */
btnLecturerAddNew.addEventListener('click', () => {
    document.getElementById('lecturerModalTitle').innerText = "Thêm Giảng viên";
    const btnSaveModal = document.getElementById('btnSaveLecturerModal');
    if (btnSaveModal) {
        btnSaveModal.setAttribute('onclick', 'saveNewLecturer()');
    } else {
        console.error("Không tìm thấy #btnSaveLecturerModal");
        return;
    }
    // reset form
    document.getElementById('lecturerName').value = '';
    document.getElementById('lecturerSchoolId').value = '';
    document.getElementById('lecturerPosition').value = '';
    document.getElementById('lecturerEmail').value = '';
    document.getElementById('lecturerPhone').value = '';

    new bootstrap.Modal(document.getElementById('lecturerModal')).show();
});

/* ============== Gửi API thêm mới ============== */
function saveNewLecturer() {
    const lecturer = {
        lecturerName: document.getElementById('lecturerName').value,
        lecturerCode: document.getElementById('lecturerCode').value,
        schoolId: parseInt(document.getElementById('lecturerSchoolId').value),
        position: document.getElementById('lecturerPosition').value,
        email: document.getElementById('lecturerEmail').value,
        phone: document.getElementById('lecturerPhone').value,
        startDate: document.getElementById('lecturerStartDate').value, // yyyy-MM-dd
        contractType: document.getElementById('lecturerContractType').value || null
    };

    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    fetch('/api/lecturers', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            [csrfHeader]: csrfToken
        },
        body: JSON.stringify(lecturer)
    }).then(res => {
        if (res.ok) {
            alert("Thêm giảng viên thành công!");
            location.reload();
        } else res.text().then(txt => alert("Thêm thất bại: " + txt));
    });
}

/* ============== Mở modal sửa giảng viên ============== */
document.addEventListener('click', async function(e) {
    const btn = e.target.closest('.btn-edit');
    if (!btn) return;

    const id = btn.getAttribute('data-id');
    try {
        const res = await fetch(`/api/lecturers/${id}`);
        if (!res.ok) throw new Error('Không lấy được dữ liệu!');
        const data = await res.json();

        document.getElementById('lecturerName').value = data.lecturerName;
        document.getElementById('lecturerSchoolId').value = data.school?.schoolId || '';
        document.getElementById('lecturerPosition').value = data.position;
        document.getElementById('lecturerEmail').value = data.email;
        document.getElementById('lecturerPhone').value = data.phone;
        document.getElementById('lecturerStartDate').value =
            data.startDate ? data.startDate.substring(0, 10) : '';

        document.getElementById('lecturerContractType').value = data.contractType || '';


        document.getElementById('lecturerModalTitle').innerText = "Chỉnh sửa Giảng viên";
        document.getElementById('btnSaveLecturerModal').setAttribute('onclick', `updateLecturer(${id})`);

        new bootstrap.Modal(document.getElementById('lecturerModal')).show();
    } catch (err) {
        console.error(err);
        alert("Lỗi khi tải dữ liệu!");
    }
});

/* ============== Gửi API cập nhật ============== */
function updateLecturer(id) {
    const lecturer = {
        lecturerName: document.getElementById('lecturerName').value,
        schoolId: parseInt(document.getElementById('lecturerSchoolId').value),
        position: document.getElementById('lecturerPosition').value,
        email: document.getElementById('lecturerEmail').value,
        phone: document.getElementById('lecturerPhone').value,
        startDate: document.getElementById('lecturerStartDate').value,
        contractType: document.getElementById('lecturerContractType').value
    };

    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    fetch(`/api/lecturers/${id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            [csrfHeader]: csrfToken
        },
        body: JSON.stringify(lecturer)
    })
    .then(res => {
        if (res.ok) {
            alert("Cập nhật thành công!");
            location.reload();
        } else {
            res.text().then(txt => alert("Cập nhật thất bại: " + txt));
        }
    });
}

/* ============== Xóa giảng viên ============== */
document.addEventListener('click', function(e) {
    const btnDelete = e.target.closest('.btn-delete');
    if (!btnDelete) return;

    const id = btnDelete.getAttribute('data-id');
    if (!confirm("Bạn có chắc muốn xóa?")) return;

    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    fetch(`/api/lecturers/${id}`, {
        method: 'DELETE',
        headers: { [csrfHeader]: csrfToken }
    })
    .then(res => {
        if (res.ok) {
            alert("Xóa thành công!");
            location.reload();
        } else res.text().then(txt => alert("Xóa thất bại: " + txt));
    });
});
</script>

	<!-- Core JS -->
	<script th:src="@{/assets/js/core/jquery-3.7.1.min.js}"></script>
	<script th:src="@{/assets/js/core/popper.min.js}"></script>
	<script th:src="@{/assets/js/core/bootstrap.min.js}"></script>

	<!-- Plugins -->
	<script
		th:src="@{/assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js}"></script>
	<script th:src="@{/assets/js/plugin/chart.js/chart.min.js}"></script>
	<script
		th:src="@{/assets/js/plugin/jquery.sparkline/jquery.sparkline.min.js}"></script>
	<script th:src="@{/assets/js/plugin/chart-circle/circles.min.js}"></script>
	<script th:src="@{/assets/js/plugin/datatables/datatables.min.js}"></script>
	<script
		th:src="@{/assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js}"></script>
	<script th:src="@{/assets/js/plugin/jsvectormap/jsvectormap.min.js}"></script>
	<script th:src="@{/assets/js/plugin/jsvectormap/world.js}"></script>
	<script th:src="@{/assets/js/plugin/gmaps/gmaps.js}"></script>
	<script th:src="@{/assets/js/plugin/sweetalert/sweetalert.min.js}"></script>
	<script th:src="@{/assets/js/kaiadmin.min.js}"></script>

</body>
</html>
