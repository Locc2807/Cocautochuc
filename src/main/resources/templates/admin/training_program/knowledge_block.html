<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="admin/fragment/head :: head"></head>

<body>
	<div class="wrapper">

		<!-- Sidebar -->
		<div th:replace="admin/fragment/aside :: aside"></div>

		<div class="main-panel">
			<!-- Header -->
			<div th:replace="admin/fragment/header :: header"></div>

			<div class="container">
				<div class="page-inner">
					<div class="page-header">
						<h4 class="page-title">Danh sách Khối Kiến Thức</h4>
					</div>

					<!-- Form tìm kiếm -->
					<form class="row mb-3"
						th:action="@{/admin/training_program/knowledge_block}"
						method="get">
						<div class="col-md-4">
							<input type="text" class="form-control" name="keyword"
								placeholder="Tìm kiếm theo tên" th:value="${keyword}">
						</div>
						<div class="col-md-2">
							<button type="submit" class="btn btn-primary">Tìm / Lọc</button>
						</div>
					</form>

					<!-- Nút thêm / chỉnh sửa / hủy -->
					<div
						class="mb-3 d-flex justify-content-end align-items-center gap-2">
						<button type="button" id="btnAddNew"
							class="btn btn-success d-none">
							<i class="fa fa-plus"></i> Thêm mới
						</button>
						<button type="button" id="btnEditToggle" class="btn btn-warning">
							<i class="fa fa-pen"></i> Chỉnh sửa
						</button>
						<button type="button" id="btnCancelEdit"
							class="btn btn-secondary d-none">
							<i class="fa fa-times"></i> Hủy chỉnh sửa
						</button>
					</div>

					<!-- Grid Card Layout -->
					<div class="row"
						th:if="${blockPage != null and blockPage.content.size() > 0}">
						<div class="col-md-4 mb-3" th:each="block : ${blockPage.content}">
							<div class="card shadow-sm">
								<div class="card-body">
									<h5 class="card-title" th:text="${block.name}">Tên Khối</h5>
									<p class="card-text">
										<strong>Mã Khối:</strong> <span th:text="${block.blockCode}"></span><br>
										<strong>Tín chỉ bắt buộc:</strong> <span
											th:text="${block.minRequiredCredits != null ? block.minRequiredCredits : 0}"></span><br>
										<strong>Tín chỉ tự chọn:</strong> <span
											th:text="${block.electiveCredits != null ? block.electiveCredits : 0}"></span><br>
										<strong>Số môn:</strong> <span
											th:text="${block.subjectCount != null ? block.subjectCount : 0}"></span>
									</p>

									<!-- Nút Sửa/Xóa -->
									<div
										class="edit-column d-none d-flex justify-content-end gap-2">
										<button class="btn btn-sm btn-primary btn-edit" title="Sửa"
											th:data-id="${block.blockCode}">
											<i class="fa fa-edit"></i>
										</button>
										<button class="btn btn-sm btn-danger btn-delete" title="Xóa"
											th:data-id="${block.blockCode}">
											<i class="fa fa-trash"></i>
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div th:if="${blockPage == null or blockPage.content.size() == 0}">
						<p class="text-center">Không có khối kiến thức nào để hiển
							thị.</p>
					</div>

					<!-- Phân trang -->
					<div class="d-flex justify-content-center mt-3"
						th:if="${blockPage != null}">
						<ul class="pagination">
							<li class="page-item"
								th:classappend="${!blockPage.hasPrevious()} ? 'disabled'">
								<a class="page-link"
								th:href="@{/admin/training_program/knowledge_block(page=${blockPage.number - 1}, size=${blockPage.size}, keyword=${keyword})}">«</a>
							</li>
							<li class="page-item"
								th:each="i : ${#numbers.sequence(0, blockPage.totalPages - 1)}"
								th:classappend="${i == blockPage.number} ? 'active'"><a
								class="page-link"
								th:href="@{/admin/training_program/knowledge_block(page=${i}, size=${blockPage.size}, keyword=${keyword})}"
								th:text="${i + 1}"></a></li>
							<li class="page-item"
								th:classappend="${!blockPage.hasNext()} ? 'disabled'"><a
								class="page-link"
								th:href="@{/admin/training_program/knowledge_block(page=${blockPage.number + 1}, size=${blockPage.size}, keyword=${keyword})}">»</a>
							</li>
						</ul>
					</div>

				</div>
			</div>

			<!-- Footer -->
			<div th:replace="admin/fragment/footer :: footer"></div>
		</div>
	</div>

	<!-- Core JS & Plugins -->
	<script th:src="@{/assets/js/core/jquery-3.7.1.min.js}"></script>
	<script th:src="@{/assets/js/core/popper.min.js}"></script>
	<script th:src="@{/assets/js/core/bootstrap.min.js}"></script>
	<script
		th:src="@{/assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js}"></script>
	<script th:src="@{/assets/js/plugin/chart.js/chart.min.js}"></script>
	<script
		th:src="@{/assets/js/plugin/jquery.sparkline/jquery.sparkline.min.js}"></script>
	<script th:src="@{/assets/js/plugin/chart-circle/circles.min.js}"></script>
	<script th:src="@{/assets/js/plugin/datatables/datatables.min.js}"></script>
	<script
		th:src="@{/assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js}"></script>
	<script th:src="@{/assets/js/plugin/jsvectormap/jsvectormap.min.js}"></script>
	<script th:src="@{/assets/js/plugin/jsvectormap/world.js}"></script>
	<script th:src="@{/assets/js/plugin/gmaps/gmaps.js}"></script>
	<script th:src="@{/assets/js/plugin/sweetalert/sweetalert.min.js}"></script>
	<script th:src="@{/assets/js/kaiadmin.min.js}"></script>

	<!-- Modal Add/Edit Knowledge Block -->
	<div class="modal fade" id="addBlockModal" tabindex="-1"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="modalTitle">Thêm Khối Kiến Thức</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<form>
						<div class="mb-3">
							<label class="form-label">Mã Khối</label> <input type="text"
								id="blockCode" class="form-control">
						</div>
						<div class="mb-3">
							<label class="form-label">Tên Khối</label> <input type="text"
								id="blockName" class="form-control">
						</div>
						<div class="mb-3">
							<label class="form-label">Tín chỉ bắt buộc</label> <input
								type="number" id="minRequiredCredits" class="form-control"
								min="0">
						</div>
						<div class="mb-3">
							<label class="form-label">Tín chỉ tự chọn</label> <input
								type="number" id="electiveCredits" class="form-control" min="0">
						</div>
						<div class="mb-3">
							<label class="form-label">Số môn</label> <input type="number"
								id="subjectCount" class="form-control" min="0">
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">Đóng</button>
					<button type="button" id="btnSaveModal" class="btn btn-success"
						onclick="saveNewBlock()">Lưu</button>
				</div>
			</div>
		</div>
	</div>

	<!-- JS CRUD + Toggle -->
	<script>
const btnEditToggle = document.getElementById('btnEditToggle');
const btnCancel = document.getElementById('btnCancelEdit');
const btnAddNew = document.getElementById('btnAddNew');
const editColumns = document.querySelectorAll('.edit-column');

btnEditToggle.addEventListener('click', () => {
    editColumns.forEach(c => c.classList.remove('d-none'));
    btnAddNew.classList.remove('d-none');
    btnEditToggle.classList.add('d-none');
    btnCancel.classList.remove('d-none');
});

btnCancel.addEventListener('click', () => {
    editColumns.forEach(c => c.classList.add('d-none'));
    btnAddNew.classList.add('d-none');
    btnEditToggle.classList.remove('d-none');
    btnCancel.classList.add('d-none');
});

// Thêm mới
btnAddNew.addEventListener('click', () => {
    document.getElementById('modalTitle').innerText = "Thêm Khối Kiến Thức";
    document.getElementById('btnSaveModal').setAttribute('onclick', 'saveNewBlock()');
    document.getElementById('blockCode').value = '';
    document.getElementById('blockName').value = '';
    document.getElementById('minRequiredCredits').value = '';
    document.getElementById('electiveCredits').value = '';
    document.getElementById('subjectCount').value = '';
    new bootstrap.Modal(document.getElementById('addBlockModal')).show();
});

// Hàm thêm mới
async function saveNewBlock() {
    const block = {
        blockCode: document.getElementById('blockCode').value.trim(),
        name: document.getElementById('blockName').value.trim(),
        minRequiredCredits: parseInt(document.getElementById('minRequiredCredits').value),
        electiveCredits: parseInt(document.getElementById('electiveCredits').value) || 0,
        subjectCount: parseInt(document.getElementById('subjectCount').value)
    };

    if (!block.blockCode) { alert("Mã khối không được để trống!"); return; }
    if (!block.name) { alert("Tên khối không được để trống!"); return; }
    if (isNaN(block.minRequiredCredits) || block.minRequiredCredits < 0) { 
        alert("Tín chỉ bắt buộc không hợp lệ!"); return; 
    }
    if (isNaN(block.subjectCount) || block.subjectCount < 0) { 
        alert("Số môn không hợp lệ!"); return; 
    }

    const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
    const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
    const headers = {'Content-Type': 'application/json'};
    if (csrfTokenMeta && csrfHeaderMeta) {
        headers[csrfHeaderMeta.getAttribute('content')] = csrfTokenMeta.getAttribute('content');
    }

    try {
        const res = await fetch('/api/knowledge-blocks', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(block)
        });

        if (res.ok) {
            alert("Thêm khối kiến thức thành công!");
            location.reload();
        } else {
            const txt = await res.text();
            alert("Thêm thất bại: " + txt);
        }
    } catch(e) {
        console.error(e);
        alert("Lỗi khi thêm khối kiến thức!");
    }
}

// Edit
document.addEventListener('click', async function(e){
    const btn = e.target.closest('.btn-edit'); if(!btn) return;
    const id = btn.getAttribute('data-id');
    try {
        const res = await fetch(`/api/knowledge-blocks/${id}`);
        if(!res.ok) throw new Error('Không lấy được dữ liệu!');
        const data = await res.json();

        document.getElementById('blockCode').value = data.blockCode;
        document.getElementById('blockName').value = data.name;
        document.getElementById('minRequiredCredits').value = data.minRequiredCredits || 0;
        document.getElementById('electiveCredits').value = data.electiveCredits || 0;
        document.getElementById('subjectCount').value = data.subjectCount || 0;

        document.getElementById('modalTitle').innerText = "Chỉnh sửa Khối Kiến Thức";
        document.getElementById('btnSaveModal').setAttribute('onclick', `updateBlock('${id}')`);
        new bootstrap.Modal(document.getElementById('addBlockModal')).show();
    } catch(e) { console.error(e); alert("Lỗi khi tải dữ liệu!"); }
});

async function updateBlock(id) {
    const block = {
        blockCode: document.getElementById('blockCode').value.trim(),
        name: document.getElementById('blockName').value.trim(),
        minRequiredCredits: parseInt(document.getElementById('minRequiredCredits').value) || 0,
        electiveCredits: parseInt(document.getElementById('electiveCredits').value) || 0,
        subjectCount: parseInt(document.getElementById('subjectCount').value) || 0
    };

    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    try {
        const res = await fetch(`/api/knowledge-blocks/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json', [csrfHeader]: csrfToken},
            body: JSON.stringify(block)
        });
        if(res.ok) location.reload();
        else { const txt = await res.text(); alert("Cập nhật thất bại: " + txt); }
    } catch(e){ console.error(e); alert("Lỗi khi cập nhật!"); }
}

// Delete
document.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-delete'); if(!btn) return;
    const id = btn.getAttribute('data-id');
    if(!confirm("Bạn có chắc chắn muốn xóa khối kiến thức này?")) return;
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    fetch(`/api/knowledge-blocks/${id}`, {
        method:'DELETE',
        headers:{[csrfHeader]: csrfToken}
    }).then(res=>{if(res.ok) location.reload(); else res.text().then(txt=>alert("Xóa thất bại: "+txt))})
      .catch(err=>console.error(err));
});
</script>

</body>
</html>
