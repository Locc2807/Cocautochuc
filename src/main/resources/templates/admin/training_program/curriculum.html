<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="admin/fragment/head :: head"></head>

<body>
<div class="wrapper">
    <div th:replace="admin/fragment/aside :: aside"></div>

    <div class="main-panel">
        <div th:replace="admin/fragment/header :: header"></div>

        <div class="container">
            <div class="page-inner">
                <div class="page-header">
                    <h4 class="page-title">üìö Qu·∫£n l√Ω Ch∆∞∆°ng Tr√¨nh ƒê√†o T·∫°o (Curriculum)</h4>
                </div>

                <!-- Form t√¨m ki·∫øm -->
                <form class="row mb-3" th:action="@{/admin/curriculum}" method="get">
                    <div class="col-md-3">
                        <input type="text" class="form-control" name="keyword"
                               placeholder="T√¨m ki·∫øm theo m√£ CTƒêT" th:value="${keyword}">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" name="batchId">
                            <option value="">--Ch·ªçn Kh√≥a--</option>
                            <option th:each="b : ${batches}" th:value="${b.batchId}"
                                    th:text="${b.batchCode}" th:selected="${b.batchId == batchId}"></option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary">T√¨m</button>
                    </div>
                </form>

                <!-- N√∫t th√™m/s·ª≠a/l∆∞u/h·ªßy -->
                <div class="mb-3 d-flex justify-content-end align-items-center gap-2">
                    <button type="button" id="btnAddNewCurriculum" class="btn btn-success d-none">
                        <i class="fa fa-plus"></i> Th√™m m·ªõi
                    </button>
                    <button type="button" id="btnEditToggleCurriculum" class="btn btn-warning">
                        <i class="fa fa-pen"></i> Ch·ªânh s·ª≠a
                    </button>
                    <button type="button" id="btnSaveChangesCurriculum" class="btn btn-success d-none">
                        <i class="fa fa-save"></i> L∆∞u thay ƒë·ªïi
                    </button>
                    <button type="button" id="btnCancelEditCurriculum" class="btn btn-secondary d-none">
                        <i class="fa fa-times"></i> H·ªßy ch·ªânh s·ª≠a
                    </button>
                </div>

                <!-- B·∫£ng Curriculum -->
                <div class="card p-3">
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                        <tr>
                            <th>M√£ CTƒêT</th>
                            <th>Kh√≥a</th>
                            <th>Ng√†nh</th>
                            <th>Th·ªùi gian (nƒÉm)</th>
                            <th>T·ªïng m√¥n</th>
                            <th>T·ªïng t√≠n ch·ªâ</th>
                            <th>M√¥ t·∫£</th>
                            <th class="edit-column d-none">Thao t√°c</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="c : ${curriculumPage.content}">
                            <td th:text="${c.curriculumCode}"></td>
                            <td th:text="${c.batch.batchCode}"></td>
                            <td th:text="${c.major.majorName}"></td>
                            <td th:text="${c.durationYears}"></td>
                            <td th:text="${c.totalSubjects}"></td>
                            <td th:text="${c.totalCredits}"></td>
                            <td th:text="${c.description}"></td>
                            <td class="edit-column d-none">
                                <button class="btn btn-sm btn-primary me-1 btn-edit" title="S·ª≠a" th:data-id="${c.id}">
                                    <i class="fa fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger btn-delete" title="X√≥a" th:data-id="${c.id}">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                    <!-- Pagination -->
                    <div class="d-flex justify-content-center mt-3">
                        <ul class="pagination">
                            <li class="page-item" th:classappend="${!curriculumPage.hasPrevious()} ? 'disabled'">
                                <a class="page-link"
                                   th:href="@{/admin/curriculum(page=${curriculumPage.number - 1}, size=${curriculumPage.size}, keyword=${keyword})}">¬´</a>
                            </li>
                            <li class="page-item"
                                th:each="i : ${#numbers.sequence(0, curriculumPage.totalPages - 1)}"
                                th:classappend="${i == curriculumPage.number} ? 'active'">
                                <a class="page-link"
                                   th:href="@{/admin/curriculum(page=${i}, size=${curriculumPage.size}, keyword=${keyword})}"
                                   th:text="${i + 1}"></a>
                            </li>
                            <li class="page-item" th:classappend="${!curriculumPage.hasNext()} ? 'disabled'">
                                <a class="page-link"
                                   th:href="@{/admin/curriculum(page=${curriculumPage.number + 1}, size=${curriculumPage.size}, keyword=${keyword})}">¬ª</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div th:replace="admin/fragment/footer :: footer"></div>
    </div>
</div>

<!-- Modal th√™m/s·ª≠a Curriculum -->
<div class="modal fade" id="curriculumModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Th√™m Curriculum m·ªõi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="curriculumForm">
                    <input type="hidden" id="curriculumId">
                    <div class="mb-2">
                        <label>Kh√≥a:</label>
                        <select id="batchId" class="form-select" required>
                            <option th:each="b : ${batches}" th:value="${b.batchId}" th:text="${b.batchCode}"></option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>Ng√†nh:</label>
                        <select id="majorId" class="form-select" required>
                            <option th:each="m : ${majors}" th:value="${m.majorId}" th:text="${m.majorName}"></option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>M√£ CTƒêT:</label>
                        <input type="text" id="curriculumCode" class="form-control" required>
                    </div>
                    <div class="mb-2">
                        <label>Th·ªùi gian ƒë√†o t·∫°o (nƒÉm):</label>
                        <input type="number" id="durationYears" class="form-control" min="1">
                    </div>
                    <div class="mb-2">
                        <label>T·ªïng s·ªë m√¥n:</label>
                        <input type="number" id="totalSubjects" class="form-control" min="0">
                    </div>
                    <div class="mb-2">
                        <label>T·ªïng t√≠n ch·ªâ:</label>
                        <input type="number" id="totalCredits" class="form-control" min="0">
                    </div>
                    <div class="mb-2">
                        <label>M√¥ t·∫£:</label>
                        <input type="text" id="description" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-success" id="btnSaveModal">L∆∞u</button>
            </div>
        </div>
    </div>
</div>

<!-- Core JS -->
<script th:src="@{/assets/js/core/jquery-3.7.1.min.js}"></script>
<script th:src="@{/assets/js/core/popper.min.js}"></script>
<script th:src="@{/assets/js/core/bootstrap.min.js}"></script>

<!-- Plugins -->
<script th:src="@{/assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js}"></script>
<script th:src="@{/assets/js/plugin/chart.js/chart.min.js}"></script>
<script th:src="@{/assets/js/plugin/jquery.sparkline/jquery.sparkline.min.js}"></script>
<script th:src="@{/assets/js/plugin/chart-circle/circles.min.js}"></script>
<script th:src="@{/assets/js/plugin/datatables/datatables.min.js}"></script>
<script th:src="@{/assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js}"></script>
<script th:src="@{/assets/js/plugin/jsvectormap/jsvectormap.min.js}"></script>
<script th:src="@{/assets/js/plugin/jsvectormap/world.js}"></script>
<script th:src="@{/assets/js/plugin/gmaps/gmaps.js}"></script>
<script th:src="@{/assets/js/plugin/sweetalert/sweetalert.min.js}"></script>
<script th:src="@{/assets/js/kaiadmin.min.js}"></script>

<script th:inline="javascript">
// Toggle Edit Columns
const btnEditToggleCurriculum = document.getElementById('btnEditToggleCurriculum');
const btnSaveChangesCurriculum = document.getElementById('btnSaveChangesCurriculum');
const btnCancelEditCurriculum = document.getElementById('btnCancelEditCurriculum');
const btnAddNewCurriculum = document.getElementById('btnAddNewCurriculum');
const editColumnsCurriculum = document.querySelectorAll('.edit-column');

btnEditToggleCurriculum.addEventListener('click', () => {
    editColumnsCurriculum.forEach(col => col.classList.remove('d-none'));
    btnAddNewCurriculum.classList.remove('d-none');
    btnEditToggleCurriculum.classList.add('d-none');
    btnSaveChangesCurriculum.classList.remove('d-none');
    btnCancelEditCurriculum.classList.remove('d-none');
});

btnCancelEditCurriculum.addEventListener('click', () => {
    editColumnsCurriculum.forEach(col => col.classList.add('d-none'));
    btnAddNewCurriculum.classList.add('d-none');
    btnEditToggleCurriculum.classList.remove('d-none');
    btnSaveChangesCurriculum.classList.add('d-none');
    btnCancelEditCurriculum.classList.add('d-none');
});

// M·ªü modal th√™m m·ªõi
btnAddNewCurriculum.addEventListener('click', () => {
    document.getElementById('modalTitle').innerText = "Th√™m Curriculum m·ªõi";
    document.getElementById('curriculumId').value = "";
    document.getElementById('curriculumCode').value = "";
    document.getElementById('batchId').value = "";
    document.getElementById('majorId').value = "";
    document.getElementById('durationYears').value = "";
    document.getElementById('totalSubjects').value = "";
    document.getElementById('totalCredits').value = "";
    document.getElementById('description').value = "";
    new bootstrap.Modal(document.getElementById('curriculumModal')).show();
});

// L∆∞u (Th√™m ho·∫∑c S·ª≠a)
// L∆∞u (Th√™m ho·∫∑c S·ª≠a)
document.getElementById('btnSaveModal').addEventListener('click', () => {
    const id = document.getElementById('curriculumId').value;
    const batchValue = document.getElementById('batchId').value;
    const majorValue = document.getElementById('majorId').value;

    if (!batchValue || !majorValue) {
        alert('Vui l√≤ng ch·ªçn Kh√≥a v√† Ng√†nh!');
        return;
    }

    // JSON theo DTO
    const curriculumDTO = {
        curriculumCode: document.getElementById('curriculumCode').value.trim(),
        batchId: parseInt(batchValue),
        majorId: parseInt(majorValue),
        durationYears: parseInt(document.getElementById('durationYears').value) || 0,
        totalSubjects: parseInt(document.getElementById('totalSubjects').value) || 0,
        totalCredits: parseInt(document.getElementById('totalCredits').value) || 0,
        description: document.getElementById('description').value.trim()
    };

    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    let url = '/api/curriculums';
    let method = 'POST';
    if(id) { // n·∫øu id t·ªìn t·∫°i => PUT (update)
        url += `/${id}`;
        method = 'PUT';
    }

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            [csrfHeader]: csrfToken
        },
        body: JSON.stringify(curriculumDTO)
    })
    .then(res => {
        if(res.ok) {
            location.reload();
        } else {
            res.text().then(txt => alert('L∆∞u th·∫•t b·∫°i: ' + txt));
        }
    })
    .catch(err => console.error(err));
});


// Ch·ªânh s·ª≠a Curriculum
document.addEventListener('click', async function(e){
    const btnEdit = e.target.closest('.btn-edit');
    if(!btnEdit) return;

    const id = btnEdit.getAttribute('data-id');
    try {
        const res = await fetch(`/api/curriculums/${id}`);
        if(!res.ok) throw new Error('Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu');
        const data = await res.json();

        document.getElementById('curriculumId').value = data.id;
        document.getElementById('curriculumCode').value = data.curriculumCode;
        document.getElementById('batchId').value = data.batch.batchId;
        document.getElementById('majorId').value = data.major.majorId;
        document.getElementById('durationYears').value = data.durationYears;
        document.getElementById('totalSubjects').value = data.totalSubjects;
        document.getElementById('totalCredits').value = data.totalCredits;
        document.getElementById('description').value = data.description;

        document.getElementById('modalTitle').innerText = "Ch·ªânh s·ª≠a Curriculum";
        new bootstrap.Modal(document.getElementById('curriculumModal')).show();
    } catch(err) {
        console.error(err);
        alert("L·ªói khi t·∫£i d·ªØ li·ªáu!");
    }
});

// X√≥a Curriculum
document.addEventListener('click', function(e){
    const btnDelete = e.target.closest('.btn-delete');
    if(!btnDelete) return;

    const id = btnDelete.getAttribute('data-id');
    if(!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a Curriculum n√†y?')) return;

    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    fetch(`/api/curriculums/${id}`, {
        method: 'DELETE',
        headers: { [csrfHeader]: csrfToken }
    })
    .then(res => {
        if(res.ok){
            alert('X√≥a th√†nh c√¥ng!');
            location.reload();
        } else {
            res.text().then(txt => alert('X√≥a th·∫•t b·∫°i: ' + txt));
        }
    })
    .catch(err => console.error(err));
});
</script>

</body>
</html>